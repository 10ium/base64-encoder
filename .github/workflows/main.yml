name: Encode Sublist and Update README

on:
  push:
    paths:
      - sublist.txt
  workflow_dispatch:

jobs:
  encode:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requirements
        run: pip install requests

      - name: Sync and encode URLs
        run: |
          import os
          import requests
          import base64
          from urllib.parse import urlparse
          import re

          os.makedirs('encoded', exist_ok=True)

          urls = []
          filenames = []
          links_to_add = []
          links_to_remove = []

          def get_unique_filename(name):
              """Make sure the file name doesn't have duplicate .txt extension."""
              if name.endswith('.txt.txt'):
                  name = name[:-4]  # Remove extra .txt if present
              return name

          with open('sublist.txt', 'r') as f:
              lines = [line.strip() for line in f if line.strip()]

          for line in lines:
              if '||' in line:
                  url, custom_name = map(str.strip, line.split('||', 1))
                  filename = f'{custom_name}.txt'
              else:
                  url = line.strip()
                  parsed = urlparse(url)

                  if 'githubusercontent.com' in parsed.netloc:
                      match = re.search(r'githubusercontent\.com/([^/]+)/[^/]+/.+?/([^/]+)$', url)
                      if match:
                          user, file = match.groups()
                          filename = f'{user}_{file}.txt'
                      else:
                          filename = f'github_unknown.txt'
                  else:
                      filename = f'unnamed.txt'

              # Get the final unique filename, ensuring no double .txt
              filename = get_unique_filename(filename)

              urls.append(url)
              filenames.append(filename)

          # Delete files not referenced
          current_set = set(filenames)
          existing_files = os.listdir('encoded')
          for fname in existing_files:
              if fname.endswith('.txt') and fname not in current_set:
                  os.remove(os.path.join('encoded', fname))
                  links_to_remove.append(fname)

          # Fetch and encode
          for url, fname in zip(urls, filenames):
              try:
                  r = requests.get(url, timeout=15)
                  r.raise_for_status()
                  encoded = base64.b64encode(r.content).decode('utf-8')
                  with open(os.path.join('encoded', fname), 'w') as f:
                      f.write(encoded)
                  if fname not in existing_files:
                      links_to_add.append(f'[Encoded {fname}](/encoded/{fname})')
              except Exception as e:
                  with open(os.path.join('encoded', fname.replace('.txt', '_error.txt')), 'w') as f:
                      f.write(f'# Error fetching {url}: {e}\n')

          # Check if README.md exists and update it
          readme_path = 'README.md'
          if os.path.exists(readme_path):
              with open(readme_path, 'r') as readme_file:
                  readme_lines = readme_file.readlines()

              # Remove links that need to be deleted
              updated_readme = [line for line in readme_lines if not any(link in line for link in links_to_remove)]

              # Add new links
              if links_to_add:
                  updated_readme.append('\n## Encoded Files\n')
                  updated_readme.extend([f'- {link}\n' for link in links_to_add])

              with open(readme_path, 'w') as readme_file:
                  readme_file.writelines(updated_readme)
          else:
              print("README.md not found, skipping update.")

        shell: python

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A encoded/ README.md
          git commit -m "Auto: update encoded files and README" || echo "Nothing to commit"
          git push
